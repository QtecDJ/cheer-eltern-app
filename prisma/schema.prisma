generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Team {
  id               Int                @id @default(autoincrement())
  name             String             @unique
  description      String?
  color            String?
  status           String             @default("active")
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  Announcement     Announcement[]
  AnnouncementTeam AnnouncementTeam[]
  members          Member[]
  trainings        TrainingSession[]

  @@index([status])
}

model Member {
  name              String
  firstName         String
  lastName          String
  email             String?            @unique
  phone             String?
  birthDate         String
  role              String
  status            String             @default("active")
  joinDate          String
  address           String?
  emergencyContact  String?
  emergencyPhone    String?
  photoUrl          String?
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  teamId            Int?
  coachTeamId       Int?
  id                Int                @id @default(autoincrement())
  lastLogin         DateTime?
  passwordHash      String?
  userRole          String?            @default("member")
  allergies         String?
  diseases          String?
  emergencyContact2 String?
  emergencyPhone2   String?
  medications       String?
  activities        Activity[]
  Announcement      Announcement[]
  AnnouncementRSVP  AnnouncementRSVP[]
  attendances       Attendance[]
  LoginLog          LoginLog[]
  // Messages relations (tickets)
  messagesSent      Message[]          @relation("MessageSender")
  messagesAssigned  Message[]          @relation("MessageAssignee")
  messageReplies    MessageReply[]
  team              Team?              @relation(fields: [teamId], references: [id])
  notifications     Notification[]
  PollVote          PollVote[]
  competitions      Competition[]      @relation("CompetitionParticipants")
  events            Event[]            @relation("EventParticipations")
  trainings         TrainingSession[]  @relation("TrainingParticipants")
  pushSubscriptions PushSubscription[]
  // Neue Spalte: Rollen als Array (backwards-compatible zu `userRole` string)
  roles            String[]  @default([])

  @@index([email])
  @@index([status])
  @@index([teamId])
  @@index([createdAt])
  @@index([status, teamId])
}

model TrainingSession {
  title           String
  date            String
  time            String
  location        String
  maxParticipants Int
  type            String
  status          String         @default("upcoming")
  description     String?
  trainer         String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  id              Int            @id @default(autoincrement())
  archivedAt      DateTime?
  isArchived      Boolean        @default(false)
  teamId          Int?
  notifications   Notification[]
  team            Team?          @relation(fields: [teamId], references: [id])
  participants    Member[]       @relation("TrainingParticipants")

  @@index([date])
  @@index([status])
  @@index([type])
  @@index([isArchived])
  @@index([status, isArchived])
  @@index([date, status])
  @@index([teamId])
}

model TrainingAssessment {
  id                 Int      @id @default(autoincrement())
  memberId           Int
  trainingSessionId  Int
  assessedBy         String
  date               DateTime @default(now())
  tumblingTechnique  Float
  stuntExecution     Float
  heightControl      Float
  choreographyMemory Float
  synchronization    Float
  facialExpression   Float
  sharpness          Float
  flexibility        Float
  strength           Float
  endurance          Float
  speed              Float
  teamwork           Float
  leadership         Float
  coachability       Float
  attitude           Float
  overallScore       Float
  performanceLevel   String
  strengths          String?
  areasToImprove     String?
  goals              String?
  privateNotes       String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([memberId])
  @@index([trainingSessionId])
  @@index([date])
  @@index([performanceLevel])
}

model Attendance {
  id            Int      @id @default(autoincrement())
  memberId      Int
  date          DateTime @default(now())
  type          String
  status        String
  notes         String?
  trainingId    Int?
  eventId       Int?
  competitionId Int?
  recordedBy    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  teamId        Int?
  reason        String?
  member        Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([date])
  @@index([type])
  @@index([status])
  @@index([teamId])
  @@index([memberId, date])
  @@index([type, date])
  @@index([memberId, status])
  @@index([trainingId, memberId])
  @@index([memberId, type, date(sort: Desc)])
}

model Activity {
  id          Int      @id @default(autoincrement())
  memberId    Int
  type        String
  category    String
  title       String
  description String?
  value       Float?
  date        DateTime @default(now())
  recordedBy  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  member      Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([type])
  @@index([category])
  @@index([date])
}

model Notification {
  id                Int              @id @default(autoincrement())
  memberId          Int
  type              String
  title             String
  message           String
  link              String?
  isRead            Boolean          @default(false)
  trainingSessionId Int?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  member            Member           @relation(fields: [memberId], references: [id], onDelete: Cascade)
  trainingSession   TrainingSession? @relation(fields: [trainingSessionId], references: [id])

  @@index([memberId])
  @@index([memberId, isRead])
  @@index([trainingSessionId])
  @@index([createdAt])
}

model Competition {
  title        String
  date         String
  location     String
  category     String
  result       String?
  status       String   @default("upcoming")
  rank         Int?
  score        Float?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  id           Int      @id @default(autoincrement())
  participants Member[] @relation("CompetitionParticipants")

  @@index([date])
  @@index([status])
  @@index([category])
  @@index([status, date])
}

model Event {
  title        String
  date         String
  time         String
  location     String
  type         String
  status       String   @default("upcoming")
  description  String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  id           Int      @id @default(autoincrement())
  participants Member[] @relation("EventParticipations")

  @@index([date])
  @@index([status])
  @@index([type])
  @@index([status, date])
}

model Announcement {
  id               Int                @id @default(autoincrement())
  title            String             @db.VarChar(255)
  content          String
  category         String             @default("news") @db.VarChar(50)
  priority         String             @default("normal") @db.VarChar(20)
  authorId         Int
  teamId           Int?
  isPinned         Boolean            @default(false)
  expiresAt        DateTime?          @db.Timestamp(6)
  createdAt        DateTime           @default(now()) @db.Timestamp(6)
  updatedAt        DateTime           @default(now()) @updatedAt @db.Timestamp(6)
  allowRsvp        Boolean?           @default(false)
  Member           Member             @relation(fields: [authorId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Team             Team?              @relation(fields: [teamId], references: [id], onUpdate: NoAction)
  rsvps            AnnouncementRSVP[]
  AnnouncementTeam AnnouncementTeam[]
  Poll             Poll[]

  @@index([category])
  @@index([expiresAt])
  @@index([createdAt(sort: Desc)])
  @@index([category, expiresAt, isPinned])
  @@index([teamId, category])
}

model AnnouncementRSVP {
  id             Int          @id @default(autoincrement())
  announcementId Int
  memberId       Int
  status         String       @db.VarChar(20)
  respondedAt    DateTime?    @default(now()) @db.Timestamp(6)
  Announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Member         Member       @relation(fields: [memberId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([announcementId, memberId])
  @@index([announcementId], map: "idx_announcement_rsvp_announcement")
  @@index([memberId], map: "idx_announcement_rsvp_member")
}

model LoginLog {
  id            Int      @id @default(autoincrement())
  memberId      Int?
  loginAt       DateTime @default(now()) @db.Timestamp(6)
  ipAddress     String?  @db.VarChar(45)
  userAgent     String?
  success       Boolean  @default(true)
  failureReason String?
  Member        Member?  @relation(fields: [memberId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model Poll {
  id             Int          @id @default(autoincrement())
  announcementId Int
  question       String
  allowMultiple  Boolean      @default(false)
  isAnonymous    Boolean      @default(false)
  endsAt         DateTime?    @db.Timestamp(6)
  createdAt      DateTime     @default(now()) @db.Timestamp(6)
  Announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  PollOption     PollOption[]
  PollVote       PollVote[]

  @@index([announcementId])
  @@index([endsAt])
}

model PollOption {
  id       Int        @id @default(autoincrement())
  pollId   Int
  text     String     @db.VarChar(255)
  order    Int        @default(0)
  Poll     Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  PollVote PollVote[]

  @@index([pollId])
  @@index([pollId, order])
}

model PollVote {
  id         Int        @id @default(autoincrement())
  pollId     Int
  optionId   Int
  memberId   Int
  votedAt    DateTime   @default(now()) @db.Timestamp(6)
  Member     Member     @relation(fields: [memberId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  PollOption PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Poll       Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([pollId, optionId, memberId])
}

model AnnouncementTeam {
  id             Int          @id @default(autoincrement())
  announcementId Int
  teamId         Int
  createdAt      DateTime?    @default(now()) @db.Timestamp(6)
  Announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Team           Team         @relation(fields: [teamId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([announcementId, teamId])
  @@index([announcementId], map: "idx_announcement_team_announcement")
  @@index([teamId], map: "idx_announcement_team_team")
}

model PushSubscription {
  id        String   @id @default(uuid())
  memberId  Int
  endpoint  String   @unique
  p256dh    String
  auth      String
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([endpoint])
  @@map("push_subscriptions")
}

model Message {
  id         Int       @id @default(autoincrement())
  subject    String    @db.VarChar(255)
  body       String
  audience   String?
  senderId   Int
  assignedTo Int?
  status     String    @default("open") // open | assigned | resolved
  resolvedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  sender   Member         @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  assignee Member?        @relation("MessageAssignee", fields: [assignedTo], references: [id], onDelete: SetNull)
  replies  MessageReply[]

  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([senderId])
}

model MessageReply {
  id        Int      @id @default(autoincrement())
  messageId Int
  authorId  Int
  body      String
  createdAt DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  author  Member  @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([authorId])
}
